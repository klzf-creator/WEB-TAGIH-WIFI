<!doctype html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>TagihWarga</title>
    <meta name="theme-color" content="#1e40af" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <link rel="manifest" href="manifest.json" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      * {
        -webkit-tap-highlight-color: transparent;
      }
      .hide-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .hide-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .skeleton {
        background: linear-gradient(
          90deg,
          #e5e7eb 25%,
          #f3f4f6 50%,
          #e5e7eb 75%
        );
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
      }
      @keyframes shimmer {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }
      @keyframes slideUp {
        from {
          transform: translateY(100%);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }
      .modal-slide {
        animation: slideUp 0.3s ease-out;
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen pb-28">
    <!-- ========== HEADER ========== -->
    <header class="bg-blue-800 text-white sticky top-0 z-40 shadow-md">
      <div class="max-w-md mx-auto px-4 py-3 flex justify-between items-center">
        <div>
          <h1 class="font-bold text-lg">ðŸ’° TagihWarga</h1>
          <p id="headerSubtitle" class="text-blue-200 text-xs">
            Mode Penagihan
          </p>
        </div>
        <div class="text-right">
          <p class="text-[10px] text-blue-200 uppercase tracking-wide">
            Setoran Hari Ini
          </p>
          <p
            id="todayTotal"
            class="font-bold text-lg leading-none text-green-300"
          >
            Rp 0
          </p>
        </div>
      </div>
    </header>

    <!-- ========== MONTH NAVIGATOR ========== -->
    <div class="bg-white border-b sticky top-[60px] z-30 shadow-sm">
      <div class="max-w-md mx-auto px-4 py-2 flex items-center justify-between">
        <button
          onclick="App.changeMonth(-1)"
          class="p-2 text-gray-500 hover:bg-gray-100 rounded-lg"
        >
          â—€
        </button>
        <button
          id="monthDisplay"
          onclick="App.refresh()"
          class="font-bold text-gray-800"
        >
          ...
        </button>
        <button
          onclick="App.changeMonth(1)"
          class="p-2 text-gray-500 hover:bg-gray-100 rounded-lg"
        >
          â–¶
        </button>
      </div>
    </div>

    <!-- ========== MAIN ========== -->
    <main class="max-w-md mx-auto">
      <!-- Due Date Tabs -->
      <div class="px-4 pt-4">
        <p class="text-xs font-bold text-gray-400 uppercase mb-2">
          Pilih Tanggal Jatuh Tempo
        </p>
        <div
          id="dueDateButtons"
          class="flex gap-2 overflow-x-auto hide-scrollbar pb-1"
        >
          <div class="skeleton w-20 h-10 rounded-xl"></div>
          <div class="skeleton w-20 h-10 rounded-xl"></div>
        </div>
      </div>

      <!-- Search -->
      <div class="px-4 pt-4 sticky top-[110px] z-20 bg-gray-50 pb-2">
        <div class="relative">
          <input
            type="text"
            id="searchInput"
            onkeyup="App.handleSearch(this.value)"
            placeholder="ðŸ” Cari nama / kode / alamat..."
            class="w-full pl-10 pr-4 py-3 rounded-xl border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none shadow-sm text-sm"
          />
          <div
            class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
          >
            <span class="text-gray-400 text-lg">ðŸ”Ž</span>
          </div>
        </div>
        <div class="flex justify-between items-center mt-2 px-1">
          <span id="totalCount" class="text-xs font-bold text-gray-500"
            >...</span
          >
          <span id="totalBill" class="text-xs font-bold text-blue-600"></span>
        </div>
      </div>

      <!-- Filter -->
      <div id="filterTabs" class="px-4 pb-2">
        <div class="flex bg-gray-200 rounded-lg p-1">
          <button
            id="filterUnpaid"
            onclick="App.setFilter('unpaid')"
            class="flex-1 py-1.5 text-sm font-bold rounded-md bg-white text-red-600 shadow-sm transition-all"
          >
            Belum Lunas
          </button>
          <button
            id="filterAll"
            onclick="App.setFilter('all')"
            class="flex-1 py-1.5 text-sm font-bold rounded-md text-gray-500 transition-all"
          >
            Semua
          </button>
        </div>
      </div>

      <!-- Customer List -->
      <div id="customerList" class="px-4 min-h-[300px]"></div>

      <!-- Empty State -->
      <div id="emptyState" class="hidden px-4 pt-12 text-center">
        <div class="text-5xl mb-2">ðŸ“…</div>
        <p class="text-gray-500">Pilih tanggal di atas</p>
      </div>
    </main>

    <!-- ========== FABs ========== -->
    <button
      onclick="App.openAddModal()"
      class="fixed bottom-24 right-6 bg-green-600 text-white w-14 h-14 rounded-full shadow-xl hover:bg-green-700 active:scale-95 z-40 flex items-center justify-center text-2xl"
    >
      âž•
    </button>
    <button
      onclick="App.refresh()"
      class="fixed bottom-6 right-6 bg-blue-600 text-white w-14 h-14 rounded-full shadow-xl hover:bg-blue-700 active:scale-95 z-40 flex items-center justify-center text-2xl"
    >
      ðŸ”„
    </button>

    <!-- ========== PAYMENT MODAL ========== -->
    <div id="paymentModal" class="fixed inset-0 z-[60] hidden">
      <div
        class="absolute inset-0 bg-black/60 backdrop-blur-sm"
        onclick="App.closePaymentModal()"
      ></div>
      <div
        class="absolute bottom-0 w-full max-w-md mx-auto left-0 right-0 bg-white rounded-t-2xl p-5 modal-slide"
      >
        <div class="flex justify-center mb-2">
          <div class="w-10 h-1 bg-gray-300 rounded-full"></div>
        </div>
        <h2 class="text-lg font-bold mb-1">Terima Pembayaran</h2>
        <p id="modalCustomerName" class="text-sm text-gray-500 mb-4">-</p>

        <form onsubmit="return App.submitPayment(event);">
          <input type="hidden" id="payCustomerId" />

          <div class="mb-4">
            <label class="block text-xs font-bold text-gray-500 uppercase mb-1"
              >Uang Diterima (Rp)</label
            >
            <input
              type="tel"
              id="payAmount"
              required
              inputmode="numeric"
              oninput="App.formatCurrencyInput(this)"
              class="w-full text-2xl font-bold p-3 border rounded-xl bg-gray-50 focus:bg-white focus:border-blue-500 focus:outline-none text-gray-800"
            />
          </div>

          <div class="mb-4">
            <div id="photoPreviewContainer" class="hidden relative mb-2">
              <img
                id="photoPreview"
                class="h-32 rounded-lg border object-cover w-full"
              />
              <button
                type="button"
                onclick="App.removePhoto()"
                class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-7 h-7 flex items-center justify-center text-sm font-bold shadow-lg"
              >
                âœ•
              </button>
            </div>
            <label
              id="photoUploadBtn"
              class="block w-full py-3 border-2 border-dashed rounded-xl text-center text-gray-400 active:bg-gray-50 cursor-pointer"
            >
              ðŸ“· Foto Bukti (Opsional)
              <input
                type="file"
                id="payPhoto"
                accept="image/*"
                capture="environment"
                class="hidden"
                onchange="App.previewPhoto(event)"
              />
            </label>
          </div>

          <button
            type="submit"
            id="btnSubmit"
            class="w-full py-3.5 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl text-lg shadow-lg shadow-green-200 disabled:opacity-50 transition-all"
          >
            âœ… Simpan Pembayaran
          </button>
        </form>
      </div>
    </div>

    <!-- ========== DETAIL MODAL ========== -->
    <div id="detailModal" class="fixed inset-0 z-[60] hidden">
      <div
        class="absolute inset-0 bg-black/60 backdrop-blur-sm"
        onclick="App.closeDetailModal()"
      ></div>
      <div
        class="absolute bottom-0 w-full max-w-md mx-auto left-0 right-0 bg-white rounded-t-2xl modal-slide max-h-[85vh] overflow-y-auto"
      >
        <div class="flex justify-center pt-3 pb-1">
          <div class="w-10 h-1 bg-gray-300 rounded-full"></div>
        </div>
        <div id="detailContent" class="px-5 pb-6">
          <!-- Dynamically filled by showDetail() -->
        </div>
      </div>
    </div>

    <!-- ========== ADD CUSTOMER MODAL ========== -->
    <div id="addModal" class="fixed inset-0 z-[70] hidden">
      <div
        class="absolute inset-0 bg-black/60 backdrop-blur-sm"
        onclick="App.closeAddModal()"
      ></div>
      <div
        class="absolute bottom-0 w-full max-w-md mx-auto left-0 right-0 bg-white rounded-t-2xl p-5 modal-slide max-h-[90vh] overflow-y-auto"
      >
        <div class="flex justify-center mb-2">
          <div class="w-10 h-1 bg-gray-300 rounded-full"></div>
        </div>
        <h2 class="text-lg font-bold mb-4 text-gray-800">
          ðŸ‘¤ Tambah Pelanggan
        </h2>

        <form onsubmit="return App.submitNewCustomer(event);">
          <!-- Row 1: Name -->
          <div class="mb-3">
            <label class="block text-xs font-bold text-gray-500 uppercase mb-1"
              >Nama Lengkap *</label
            >
            <input
              type="text"
              id="addName"
              required
              placeholder="Contoh: BUDI SANTOSO"
              class="w-full p-3 border rounded-xl bg-gray-50 focus:bg-white focus:border-blue-500 outline-none"
            />
          </div>

          <!-- Row 2: Village + Due Date -->
          <div class="grid grid-cols-3 gap-3 mb-3">
            <div class="col-span-2">
              <label
                class="block text-xs font-bold text-gray-500 uppercase mb-1"
                >Desa *</label
              >
              <input
                type="text"
                id="addVillage"
                required
                placeholder="Kloposawit"
                class="w-full p-3 border rounded-xl bg-gray-50 focus:bg-white focus:border-blue-500 outline-none"
              />
            </div>
            <div>
              <label
                class="block text-xs font-bold text-gray-500 uppercase mb-1"
                >Tgl JT *</label
              >
              <select
                id="addDueDate"
                required
                class="w-full p-3 border rounded-xl bg-gray-50 focus:bg-white focus:border-blue-500 outline-none"
              ></select>
            </div>
          </div>

          <!-- Row 3: Customer Code + Package -->
          <div class="grid grid-cols-2 gap-3 mb-3">
            <div>
              <label
                class="block text-xs font-bold text-gray-500 uppercase mb-1"
                >Kode (CP00)</label
              >
              <input
                type="text"
                id="addCode"
                placeholder="CP005xxx"
                class="w-full p-3 border rounded-xl bg-gray-50 focus:bg-white focus:border-blue-500 outline-none"
              />
            </div>
            <div>
              <label
                class="block text-xs font-bold text-gray-500 uppercase mb-1"
                >Paket</label
              >
              <select
                id="addPackage"
                class="w-full p-3 border rounded-xl bg-gray-50 focus:bg-white focus:border-blue-500 outline-none"
              >
                <option value="10 Mbps" selected>10 Mbps</option>
                <option value="15 Mbps">15 Mbps</option>
                <option value="20 Mbps">20 Mbps</option>
                <option value="30 Mbps">30 Mbps</option>
                <option value="50 Mbps">50 Mbps</option>
              </select>
            </div>
          </div>

          <!-- Row 4: Address -->
          <div class="mb-3">
            <label class="block text-xs font-bold text-gray-500 uppercase mb-1"
              >Alamat Detail</label
            >
            <input
              type="text"
              id="addAddress"
              placeholder="Dsn Krajan RT/RW 001/001"
              class="w-full p-3 border rounded-xl bg-gray-50 focus:bg-white focus:border-blue-500 outline-none"
            />
          </div>

          <!-- Row 5: Phone + Bill -->
          <div class="grid grid-cols-2 gap-3 mb-5">
            <div>
              <label
                class="block text-xs font-bold text-gray-500 uppercase mb-1"
                >No HP (628xx)</label
              >
              <input
                type="tel"
                id="addPhone"
                placeholder="6281xxx"
                class="w-full p-3 border rounded-xl bg-gray-50 focus:bg-white focus:border-blue-500 outline-none"
              />
            </div>
            <div>
              <label
                class="block text-xs font-bold text-gray-500 uppercase mb-1"
                >Tagihan (Rp)</label
              >
              <input
                type="tel"
                id="addBill"
                required
                inputmode="numeric"
                value="110.000"
                oninput="App.formatCurrencyInput(this)"
                class="w-full p-3 border rounded-xl bg-gray-50 focus:bg-white focus:border-blue-500 outline-none font-bold"
              />
            </div>
          </div>

          <!-- Buttons -->
          <div class="flex gap-3">
            <button
              type="button"
              onclick="App.closeAddModal()"
              class="flex-1 py-3 bg-gray-100 text-gray-600 font-bold rounded-xl"
            >
              Batal
            </button>
            <button
              type="submit"
              id="btnAddSubmit"
              class="flex-1 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg shadow-blue-200"
            >
              Simpan
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- ========== TOAST ========== -->
    <div
      id="toast"
      class="fixed top-5 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-xl text-sm font-bold hidden z-[80]"
    ></div>

    <!-- Service Worker Register -->
    <script>
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("/sw.js").catch(() => {});
      }
    </script>

    <script src="app.js"></script>
  </body>
</html>
